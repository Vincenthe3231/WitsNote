{% load static %}
<h2 style="margin-top: 1.25rem;">ðŸ“Š Posts Analytics</h2>

<div style="margin: .75rem 0;">
  <button type="button" class="button" onclick="adminShowTable()">ðŸ“‹ Table View</button>
  <button type="button" class="button" onclick="adminShowGraph()">ðŸ“ˆ Graph View</button>
</div>

<!-- Table View -->
<div id="post-analytics-table-view">
  <h3>Last 30 Days (Per Day)</h3>
  <table class="admin-table">
    <thead><tr><th>Date</th><th>Posts</th></tr></thead>
    <tbody>
      {% for d, c in daily_rows %}
        <tr><td>{{ d }}</td><td>{{ c }}</td></tr>
      {% empty %}
        <tr><td colspan="2">No data</td></tr>
      {% endfor %}
    </tbody>
  </table>

  <h3>Last 12 Months (Per Month)</h3>
  <table class="admin-table">
    <thead><tr><th>Month</th><th>Posts</th></tr></thead>
    <tbody>
      {% for m, c in monthly_rows %}
        <tr><td>{{ m }}</td><td>{{ c }}</td></tr>
      {% empty %}
        <tr><td colspan="2">No data</td></tr>
      {% endfor %}
    </tbody>
  </table>

  <h3>All Time (Per Year)</h3>
  <table class="admin-table">
    <thead><tr><th>Year</th><th>Posts</th></tr></thead>
    <tbody>
      {% for y, c in yearly_rows %}
        <tr><td>{{ y }}</td><td>{{ c }}</td></tr>
      {% empty %}
        <tr><td colspan="2">No data</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Graph View -->
<div id="post-analytics-graph-view" style="display:none;">
  <canvas id="dailyChart" height="110"></canvas>
  <canvas id="monthlyChart" height="110" style="margin-top: 18px;"></canvas>
  <canvas id="yearlyChart" height="110" style="margin-top: 18px;"></canvas>
</div>

{{ analytics_json|json_script:"post-analytics-data" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  function adminShowTable() {
    document.getElementById('post-analytics-table-view').style.display = 'block';
    document.getElementById('post-analytics-graph-view').style.display = 'none';
  }
  function adminShowGraph() {
    document.getElementById('post-analytics-table-view').style.display = 'none';
    document.getElementById('post-analytics-graph-view').style.display = 'block';

    // Create charts on first open only
    if (!window.__postAnalyticsChartsInitialized) {
      window.__postAnalyticsChartsInitialized = true;

      const data = JSON.parse(document.getElementById('post-analytics-data').textContent);

      // Daily (line)
      new Chart(document.getElementById('dailyChart'), {
        type: 'line',
        data: {
          labels: data.daily.labels,
          datasets: [{ label: 'Posts per Day (30d)', data: data.daily.counts }]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
      });

      // Monthly (bar)
      new Chart(document.getElementById('monthlyChart'), {
        type: 'bar',
        data: {
          labels: data.monthly.labels,
          datasets: [{ label: 'Posts per Month (12m)', data: data.monthly.counts }]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
      });

      // Yearly (bar)
      new Chart(document.getElementById('yearlyChart'), {
        type: 'bar',
        data: {
          labels: data.yearly.labels,
          datasets: [{ label: 'Posts per Year', data: data.yearly.counts }]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
      });
    }
  }
</script>

<style>
  .admin-table {
    border-collapse: collapse;
    width: 100%;
    margin-bottom: .75rem;
  }
  .admin-table th, .admin-table td {
    border: 1px solid #ddd;
    padding: .5rem .6rem;
  }
  .admin-table th {
    background: #f8f8f8;
    font-weight: 600;
  }
</style>
